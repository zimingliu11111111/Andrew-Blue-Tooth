# 蓝牙遥控器Android端项目记忆

## 项目概述 
- **双重规格支持**: 支持原始硬件规格 + PRD v1.0 BLE规格
- **核心功能**: 8键遥控器控制，学习模式，状态监控
- **技术栈**: Android + Kotlin + Jetpack Compose + BLE/蓝牙双协议

## 原始硬件规格 (遥控器端)
```
8按键遥控器: K1-K8 (上下左右+4功能键)
双色LED显示: 按键绿色(正常)/红色(低电压)  
工作参数:
- 通信距离: 空旷地100米
- 工作电压: 3V (干电池2节)
- 低压检测: 2V
- 工作电流: <20mA
- 待机电流: <1μA

学习功能:
- 最多4个遥控器
- 超过4个从1开始循环覆盖
- 支持新遥控器覆盖已学习遥控器
```

## 通信协议 (统一规格)
```
按键码值映射:
K1(上) -> 0x01    K5(功能1) -> 0x10
K2(下) -> 0x02    K6(功能2) -> 0x20  
K3(左) -> 0x04    K7(功能3) -> 0x40
K4(右) -> 0x08    K8(功能4) -> 0x80

复合按键 (位或运算):
K1+K2 -> 0x03    K2+K3 -> 0x06    K3+K4 -> 0x0C
K1+K3 -> 0x05    K2+K4 -> 0x0A    以此类推
K1+K4 -> 0x09    

按键释放: 0x00 (无遥控发射)

主机指令:
0xAA -> 请求键值指令 (每75ms发送)
0x33 -> 进入学习遥控器状态
0xCC -> 退出学习遥控器状态
```

## BLE协议规范 (PRD补充)
```
服务UUID: FFE0 (透传服务)
写特征值: FFE9 (发送数据到设备)
通知特征值: FFE4 (接收设备数据)

认证机制:
认证密码: [0x78, 0x52, 0x65, 0x14, 0x25, 0x95]
认证流程: 连接成功后立即发送6字节认证
认证响应: 设备返回非0x00值表示成功

连接参数:
- 连接超时: 10秒
- 认证超时: 5秒  
- 重连次数: 最多5次
- 重连间隔: 10秒
```

## Android应用架构
```
模块设计:
1. BluetoothManager - 蓝牙连接管理 (支持经典蓝牙+BLE)
2. RemoteProtocol - 协议处理和按键映射
3. LearningController - 学习模式管理 (4个遥控器)
4. RemoteUIController - 8键遥控器UI交互
5. StatusIndicator - 连接状态和LED状态显示

UI设计:
- 十字方向键 + 2x2功能键网格
- 按键尺寸: 70x70dp, 间距: 12dp
- 方向键蓝色, 功能键绿色, 禁用灰色
- 状态栏: 连接状态+设备名+信号强度+学习模式
```

## 权限配置
```
必需权限:
- ACCESS_FINE_LOCATION (BLE扫描)
- BLUETOOTH + BLUETOOTH_ADMIN (经典蓝牙)
- BLUETOOTH_SCAN + BLUETOOTH_CONNECT (Android 12+ BLE)
```

## 关键技术实现点
1. **双协议支持**: 同时支持经典蓝牙和BLE连接
2. **6字节认证**: BLE连接后立即发送认证密码
3. **75ms循环**: 0xAA指令循环发送间隔75ms
4. **4遥控器学习**: 本地存储，循环覆盖机制
5. **按键复合**: 位或运算实现多键组合
6. **状态同步**: 遥控器LED状态与APP状态同步显示

## 测试验证重点
- [x] 按键码值映射正确性 (0x01-0x80)
- [x] 复合按键计算逻辑 (位或运算)
- [ ] BLE FFE0服务连接和认证
- [ ] 学习模式4个遥控器循环
- [ ] 75ms 0xAA指令循环发送
- [ ] UI按键交互和状态反馈
- [ ] 自动重连和错误处理

## 开发优先级
**Week 1**: BLE连接+认证 → **Week 2**: 8键UI+协议处理 → **Week 3**: 学习模式+状态管理 → **Week 4**: 测试集成

**当前状态**: 架构设计完成，准备开始编码实现

## 最新更新记录

### 2025-08-16 按键发送逻辑优化
- **修改内容**: 
  1. 停止不必要的0xAA循环发送 (`USE_QUERY_MODE = false`)
  2. 按键松开时发送两组0x00指令 (修改`sendKeyRelease()`函数)
- **影响**: 
  - 连接后不再持续发送0xAA请求键值指令
  - 按键松开更可靠，确保设备接收到释放信号
- **代码位置**: `RemoteProtocol.kt:43,155-164`

### 2025-08-22 用户交互问题修复  
- **修改内容**:
  1. 首次权限授予后自动扫描问题修复
     - 优化权限状态管理，使用`mutableStateOf`跟踪权限变化
     - 区分首次使用和后续使用场景
     - 首次使用(无存储设备)直接扫描，有存储设备时自动连接
  2. 连接按钮需要点击两次问题修复
     - 移除设备卡片的重复onClick处理
     - 简化连接逻辑，避免双重触发
- **影响**:
  - 首次打开APP权限授予后立即开始设备扫描
  - 连接设备只需点击一次Connect按钮
  - 改善用户交互体验，消除困惑
- **代码位置**: `MainActivity.kt:41,93,289-307` `DeviceScanScreen.kt:189`